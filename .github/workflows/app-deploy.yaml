name: App Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      deploy_target:
        description: "Deploy to:"
        required: true
        default: "fad"
        type: choice
        options:
          - "fad"
          - "store"
          - "fad_store"
          - "ios_fad"
          - "ios_store"
          - "android_fad"
          - "android_store"

jobs:
  setup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'
          cache: true
          cache-key: flutter-:os:-:channel:-:version:-:arch:-:hash:-${{ hashFiles('**/pubspec.lock') }}

      - name: Get build number
        id: get_build_number
        run: |
          bash scripts/get-build-number.sh
          echo "::set-output name=build_number::$BUILD_NUMBER"

  ios-deploy:
    runs-on: ubuntu-latest
    if: ${{ contains(['fad', 'store', 'fad_store', 'ios_fad', 'ios_store'], inputs.deploy_target) }}
    steps:
      - name: Running iOS Deploy
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: './deploy/ios-deploy.yaml',
              ref: context.ref,
              inputs: {
                deploy_target: '${{ inputs.deploy_target }}',
                build_number: '${{ needs.setup.outputs.build_number }}',
              }
            })

  android-deploy:
    runs-on: ubuntu-latest
    if: ${{ contains(['fad', 'store', 'fad_store', 'android_fad', 'android_store'], inputs.deploy_target) }}
    steps:
      - name: Running Android Deploy
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: './deploy/android-deploy.yaml',
              ref: context.ref,
              inputs: {
                deploy_target: '${{ inputs.deploy_target }}',
                build_number: '${{ needs.setup.outputs.build_number }}',
              }
            })
